---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Add host record for the bootstrap host
  vars:
    cifmw_dnsmasq_host_record:
      - state: present
        ips:
          - "{{ cifmw_ocp_ipi_config.bootstrap_external_static_ip }}"
        names:
          - "{{ cifmw_ocp_ipi_config.bootstrap_host }}"
  ansible.builtin.include_role:
    name: dnsmasq
    tasks_from: manage_host_record.yml

- name: Add host-record for OCP cluster API (api_vips)
  vars:
    cifmw_dnsmasq_host_record:
      - state: present
        ips: "{{ cifmw_ocp_ipi_config.api_vips }}"
        names:
          - "api.{{ cifmw_ocp_ipi_config.cluster_name }}.{{ cifmw_ocp_ipi_config.base_domain }}"
  ansible.builtin.include_role:
    name: dnsmasq
    tasks_from: manage_host_record.yml

- name: Add addresses for OCP cluster apps (ingress_vips)
  vars:
    cifmw_dnsmasq_address: >-
      {%- set _addresses = [] -%}
      {%- set _fqdn = ('apps', cifmw_ocp_ipi_config.cluster_name,  cifmw_ocp_ipi_config.base_domain) | join('.') -%}
      {%- for _ingress_vip in cifmw_ocp_ipi_config.ingress_vips %}
      {%- set _ = _addresses.append({'state': 'present', 'ipaddr': _ingress_vip, 'domains': [_fqdn]}) -%}
      {%- endfor -%}
      {{ _addresses }}
  ansible.builtin.include_role:
    name: dnsmasq
    tasks_from: manage_address.yml

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
